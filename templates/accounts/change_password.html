{% extends 'base.html' %}

{% block title %}تغيير كلمة المرور - MyStore{% endblock %}

{% block extra_css %}
<style>
    .password-card {
        border-radius: 20px;
        overflow: hidden;
    }
    .password-card .card-header {
        background: linear-gradient(135deg, var(--primary-color) 0%, #7c3aed 100%);
        padding: 25px 30px;
    }
    .password-strength {
        height: 4px;
        border-radius: 2px;
        transition: all 0.3s;
    }
    .requirement {
        font-size: 0.875rem;
        padding: 5px 0;
    }
    .requirement i {
        width: 20px;
    }
    .requirement.valid {
        color: var(--bs-success);
    }
    .requirement.invalid {
        color: var(--bs-secondary);
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'products:home' %}" class="text-decoration-none"><i class="bi bi-house"></i> الرئيسية</a></li>
            <li class="breadcrumb-item"><a href="{% url 'accounts:profile' %}" class="text-decoration-none">حسابي</a></li>
            <li class="breadcrumb-item active">تغيير كلمة المرور</li>
        </ol>
    </nav>

    <div class="row justify-content-center">
        <div class="col-lg-5 col-md-7">
            <div class="card border-0 shadow-sm password-card">
                <div class="card-header text-white text-center">
                    <div class="mb-2">
                        <i class="bi bi-shield-lock" style="font-size: 2.5rem;"></i>
                    </div>
                    <h5 class="mb-0 fw-bold">تغيير كلمة المرور</h5>
                    <small class="opacity-75">حافظ على أمان حسابك</small>
                </div>
                <div class="card-body p-4 p-md-5">
                    <form method="post" action="{% url 'accounts:change_password' %}">
                        {% csrf_token %}
                        
                        {% if form.errors %}
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <ul class="mb-0 list-unstyled">
                                {% for field in form %}
                                    {% for error in field.errors %}
                                        <li>{{ error }}</li>
                                    {% endfor %}
                                {% endfor %}
                            </ul>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                        {% endif %}
                        
                        <!-- Current Password -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-key text-primary me-1"></i>كلمة المرور الحالية
                            </label>
                            <div class="input-group">
                                <input type="password" name="old_password" class="form-control form-control-lg" id="currentPassword" required autocomplete="current-password">
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('currentPassword', this)">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- New Password -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-lock text-primary me-1"></i>كلمة المرور الجديدة
                            </label>
                            <div class="input-group">
                                <input type="password" name="new_password1" class="form-control form-control-lg" id="newPassword" required autocomplete="new-password" oninput="checkPasswordStrength(this.value)">
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('newPassword', this)">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                            <div class="password-strength bg-secondary mt-2" id="strengthBar"></div>
                        </div>
                        
                        <!-- Password Requirements -->
                        <div class="bg-light rounded-3 p-3 mb-4">
                            <small class="text-muted d-block mb-2">متطلبات كلمة المرور:</small>
                            <div class="requirement invalid" id="req-length">
                                <i class="bi bi-circle"></i> 12 حرف على الأقل
                            </div>
                            <div class="requirement invalid" id="req-upper">
                                <i class="bi bi-circle"></i> حرف كبير واحد على الأقل
                            </div>
                            <div class="requirement invalid" id="req-lower">
                                <i class="bi bi-circle"></i> حرف صغير واحد على الأقل
                            </div>
                            <div class="requirement invalid" id="req-number">
                                <i class="bi bi-circle"></i> رقم واحد على الأقل
                            </div>
                            <div class="requirement invalid" id="req-special">
                                <i class="bi bi-circle"></i> رمز خاص واحد على الأقل (!@#$%^&*)
                            </div>
                        </div>
                        
                        <!-- Confirm Password -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-lock-fill text-primary me-1"></i>تأكيد كلمة المرور الجديدة
                            </label>
                            <div class="input-group">
                                <input type="password" name="new_password2" class="form-control form-control-lg" id="confirmPassword" required autocomplete="new-password" oninput="checkPasswordMatch()">
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('confirmPassword', this)">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                            <div id="matchMessage" class="mt-2"></div>
                        </div>
                        
                        <!-- Submit Button -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-check-lg me-1"></i>تغيير كلمة المرور
                            </button>
                            <a href="{% url 'accounts:profile' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-right me-1"></i>العودة للملف الشخصي
                            </a>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Security Tips -->
            <div class="card border-0 shadow-sm rounded-4 mt-4">
                <div class="card-body p-4">
                    <h6 class="fw-bold mb-3">
                        <i class="bi bi-lightbulb text-warning me-2"></i>نصائح أمنية
                    </h6>
                    <ul class="list-unstyled mb-0 text-muted small">
                        <li class="mb-2"><i class="bi bi-check-circle text-success me-2"></i>لا تستخدم نفس كلمة المرور في مواقع متعددة</li>
                        <li class="mb-2"><i class="bi bi-check-circle text-success me-2"></i>تجنب استخدام معلومات شخصية في كلمة المرور</li>
                        <li class="mb-2"><i class="bi bi-check-circle text-success me-2"></i>غيّر كلمة المرور بشكل دوري</li>
                        <li><i class="bi bi-check-circle text-success me-2"></i>لا تشارك كلمة المرور مع أي شخص</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function togglePassword(inputId, button) {
    const input = document.getElementById(inputId);
    const icon = button.querySelector('i');
    if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'bi bi-eye-slash';
    } else {
        input.type = 'password';
        icon.className = 'bi bi-eye';
    }
}

function checkPasswordStrength(password) {
    const requirements = {
        length: password.length >= 12,
        upper: /[A-Z]/.test(password),
        lower: /[a-z]/.test(password),
        number: /[0-9]/.test(password),
        special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
    };
    
    // Update requirement indicators
    Object.keys(requirements).forEach(req => {
        const el = document.getElementById('req-' + req);
        const icon = el.querySelector('i');
        if (requirements[req]) {
            el.className = 'requirement valid';
            icon.className = 'bi bi-check-circle-fill';
        } else {
            el.className = 'requirement invalid';
            icon.className = 'bi bi-circle';
        }
    });
    
    // Calculate strength
    const strength = Object.values(requirements).filter(Boolean).length;
    const bar = document.getElementById('strengthBar');
    const colors = ['#dc3545', '#fd7e14', '#ffc107', '#28a745', '#198754'];
    bar.style.width = (strength * 20) + '%';
    bar.style.backgroundColor = colors[strength - 1] || '#6c757d';
}

function checkPasswordMatch() {
    const newPass = document.getElementById('newPassword').value;
    const confirmPass = document.getElementById('confirmPassword').value;
    const message = document.getElementById('matchMessage');
    
    if (confirmPass === '') {
        message.innerHTML = '';
    } else if (newPass === confirmPass) {
        message.innerHTML = '<small class="text-success"><i class="bi bi-check-circle me-1"></i>كلمتا المرور متطابقتان</small>';
    } else {
        message.innerHTML = '<small class="text-danger"><i class="bi bi-x-circle me-1"></i>كلمتا المرور غير متطابقتين</small>';
    }
}
</script>
{% endblock %}
