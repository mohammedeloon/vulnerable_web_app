{% extends 'dashboard/base.html' %}

{% block title %}التقارير{% endblock %}
{% block page_title %}التقارير والإحصائيات{% endblock %}

{% block content %}
<!-- Date Filter -->
<div class="stat-card mb-4">
    <form method="get" class="row g-3 align-items-end">
        <div class="col-md-3">
            <label class="form-label">من تاريخ</label>
            <input type="date" name="from_date" class="form-control" value="{{ request.GET.from_date }}">
        </div>
        <div class="col-md-3">
            <label class="form-label">إلى تاريخ</label>
            <input type="date" name="to_date" class="form-control" value="{{ request.GET.to_date }}">
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">
                <i class="bi bi-filter me-1"></i>تصفية
            </button>
        </div>
    </form>
</div>

<!-- Stats Overview -->
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="stat-card text-center">
            <div class="bg-primary bg-opacity-10 rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                <i class="bi bi-currency-dollar text-primary" style="font-size: 1.5rem;"></i>
            </div>
            <h3 class="fw-bold text-primary mb-1">{{ total_revenue|default:0 }} ر.س</h3>
            <p class="text-muted mb-0">إجمالي المبيعات</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card text-center">
            <div class="bg-success bg-opacity-10 rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                <i class="bi bi-bag-check text-success" style="font-size: 1.5rem;"></i>
            </div>
            <h3 class="fw-bold text-success mb-1">{{ total_orders|default:0 }}</h3>
            <p class="text-muted mb-0">إجمالي الطلبات</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card text-center">
            <div class="bg-info bg-opacity-10 rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                <i class="bi bi-people text-info" style="font-size: 1.5rem;"></i>
            </div>
            <h3 class="fw-bold text-info mb-1">{{ total_customers|default:0 }}</h3>
            <p class="text-muted mb-0">إجمالي العملاء</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card text-center">
            <div class="bg-warning bg-opacity-10 rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                <i class="bi bi-box-seam text-warning" style="font-size: 1.5rem;"></i>
            </div>
            <h3 class="fw-bold text-warning mb-1">{{ total_products|default:0 }}</h3>
            <p class="text-muted mb-0">إجمالي المنتجات</p>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Sales Chart -->
    <div class="col-lg-8">
        <div class="stat-card">
            <h6 class="fw-bold mb-4"><i class="bi bi-graph-up me-2 text-primary"></i>المبيعات الشهرية</h6>
            <canvas id="salesChart" height="100"></canvas>
        </div>
    </div>
    
    <!-- Order Status -->
    <div class="col-lg-4">
        <div class="stat-card h-100">
            <h6 class="fw-bold mb-4"><i class="bi bi-pie-chart me-2 text-primary"></i>حالة الطلبات</h6>
            <canvas id="orderStatusChart" height="180"></canvas>
        </div>
    </div>
</div>

<div class="row g-4 mt-2">
    <!-- Top Selling Products -->
    <div class="col-lg-6">
        <div class="stat-card">
            <h6 class="fw-bold mb-4"><i class="bi bi-trophy me-2 text-primary"></i>أكثر المنتجات مبيعاً</h6>
            <div class="table-responsive">
                <table class="table table-sm align-middle mb-0">
                    <thead>
                        <tr>
                            <th>المنتج</th>
                            <th class="text-center">المبيعات</th>
                            <th class="text-center">الإيرادات</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in top_products %}
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    {% if product.image %}
                                    <img src="{{ product.image.url }}" class="rounded me-2" style="width: 40px; height: 40px; object-fit: cover;">
                                    {% else %}
                                    <div class="bg-light rounded me-2 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                        <i class="bi bi-image text-muted"></i>
                                    </div>
                                    {% endif %}
                                    <span>{{ product.name }}</span>
                                </div>
                            </td>
                            <td class="text-center">{{ product.total_sold }}</td>
                            <td class="text-center fw-bold">{{ product.total_revenue }} ر.س</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="text-center text-muted py-3">لا توجد بيانات</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Top Categories -->
    <div class="col-lg-6">
        <div class="stat-card">
            <h6 class="fw-bold mb-4"><i class="bi bi-tags me-2 text-primary"></i>أفضل التصنيفات</h6>
            <div class="table-responsive">
                <table class="table table-sm align-middle mb-0">
                    <thead>
                        <tr>
                            <th>التصنيف</th>
                            <th class="text-center">المنتجات</th>
                            <th class="text-center">الطلبات</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for category in top_categories %}
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="bg-primary bg-opacity-10 rounded me-2 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                        <i class="bi bi-tag text-primary"></i>
                                    </div>
                                    <span>{{ category.name }}</span>
                                </div>
                            </td>
                            <td class="text-center">{{ category.products_count }}</td>
                            <td class="text-center fw-bold">{{ category.orders_count }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="text-center text-muted py-3">لا توجد بيانات</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Sales Chart
const salesCtx = document.getElementById('salesChart').getContext('2d');
new Chart(salesCtx, {
    type: 'line',
    data: {
        labels: {{ monthly_labels|safe|default:'["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو"]' }},
        datasets: [{
            label: 'المبيعات',
            data: {{ monthly_sales|safe|default:'[0, 0, 0, 0, 0, 0]' }},
            borderColor: '#0d6efd',
            backgroundColor: 'rgba(13, 110, 253, 0.1)',
            fill: true,
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Order Status Chart
const statusCtx = document.getElementById('orderStatusChart').getContext('2d');
new Chart(statusCtx, {
    type: 'doughnut',
    data: {
        labels: ['مكتملة', 'قيد الانتظار', 'ملغية'],
        datasets: [{
            data: {{ order_status_data|safe|default:'[0, 0, 0]' }},
            backgroundColor: ['#198754', '#ffc107', '#dc3545']
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});
</script>
{% endblock %}
